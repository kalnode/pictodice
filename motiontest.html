<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <button id="btn_reqPermission" style="display: none;padding: 2em">Hey, we need sensor permission!</button>
        <div id="output_status"></div>
        <div id="output_message"></div>
    </body>

    <script>

        var btn_reqPermission = document.getElementById("btn_reqPermission")
        btn_reqPermission.addEventListener("click", () => { this.reqPermissionMotion() })
        var output_status = document.getElementById("status")
        var output_message = document.getElementById("message")

        if (typeof DeviceOrientationEvent.requestPermission === 'function') {

            // requestPermission exists, so we presume browser wants explicit user permission.
            // As of today, only iOS Safari uses this.

            // Show a control to the user
            btn_reqPermission.style.display = "block"
        } else {

            // All other browsers
            this.reqPermissionMotion()
        }

        async function reqPermissionMotion() {
        
            console.log("Checking permission")
            this.output_message.innerHTML = "Checking permission"
           
            // Check for requestPermission; use it
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {

                // Presumably only one permission controls DeviceOrientationEvent and DeviceMotionEvent, so we'll only ask for one
                await DeviceOrientationEvent.requestPermission()
                .catch( (error) => {
                    console.log("Error getting sensor permission: %O", error)
                    this.output_message.innerHTML = "ERROR"
                    this.output_status.innerHTML = "No sensor permission"
                    return // Exit logic because permission not given
                })
            }

            this.output_message.innerHTML = "SUCCESS"
            this.output_status.innerHTML = "Sensor permission allowed!"

            // Here we invoke listeners.
            // For non-requestPermission browsers, presumably they'll automatically prompt the user when we invoke a listener.

            await window.addEventListener('orientation', event => {
                console.log('Device orientation event: %O', event)
                this.output_message.innerHTML = "Orientation event!"
            })


            await window.addEventListener('devicemotion', event => {
                console.log('Device acceleration event: %O', event)

                if ((event.rotationRate.alpha > 256 || event.rotationRate.beta > 256 || event.rotationRate.gamma > 256)) {
                    this.output_message.innerHTML = "SHAKEN!"
                    setTimeout(() => {
                        this.message.innerHTML = null
                    }, "2000")
                }
            })
        }
    </script>
</html>